<!doctype html>
<html lang="fa" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù„Ø§Ú© â€” Ultra + Dashboard</title>

  <!-- Premium Persian/Arabic fonts (Display + Body) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@600;700;800;900&family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --font-body: "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, Tahoma, Arial;
      --font-display: "Noto Kufi Arabic", "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, Tahoma, Arial;

      --bg0:#050815;
      --bg1:#070b1c;

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.16);

      --text:#f3f6ff;
      --muted:rgba(243,246,255,.72);
      --muted2:rgba(243,246,255,.55);

      --accent:#7aa2ff;
      --accent2:#4ef0b5;
      --accent3:#b38cff;
      --warn:#ffd36a;
      --danger:#ff6b86;

      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --shadowSoft: 0 14px 42px rgba(0,0,0,.30);

      --r:22px;
      --drawerW: 340px;
      --blur: 16px;
    }

    html[data-theme="light"]{
      --bg0:#f6f8ff;
      --bg1:#eef3ff;

      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.64);
      --stroke: rgba(10,20,40,.10);
      --stroke2: rgba(10,20,40,.14);

      --text:#0b1224;
      --muted:rgba(11,18,36,.68);
      --muted2:rgba(11,18,36,.52);

      --accent:#2f63ff;
      --accent2:#00b778;
      --accent3:#7b4dff;
      --warn:#c98a00;
      --danger:#d93b5f;

      --shadow: 0 18px 60px rgba(18,32,70,.14);
      --shadowSoft: 0 12px 34px rgba(18,32,70,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font-body);
      background: radial-gradient(1200px 800px at 20% 0%, var(--bg1), var(--bg0));
      color: var(--text);
      line-height: 1.85;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      padding-bottom: calc(104px + env(safe-area-inset-bottom));
      overflow-x:hidden;
    }

    /* Scene */
    .scene{
      position:fixed; inset:0; z-index:-3; pointer-events:none;
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(122,162,255,.20), transparent 60%),
        radial-gradient(860px 560px at 82% 18%, rgba(78,240,181,.14), transparent 62%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,211,106,.12), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 28%, rgba(0,0,0,.22));
      filter:saturate(1.06);
    }
    .scene::before,
    .scene::after{
      content:"";
      position:absolute;
      width: 900px;
      height: 900px;
      border-radius: 999px;
      filter: blur(60px);
      opacity:.55;
      transform: translate3d(0,0,0);
      mix-blend-mode: screen;
    }
    .scene::before{
      left:-260px; top:-240px;
      background: conic-gradient(from 130deg,
        rgba(122,162,255,.55),
        rgba(179,140,255,.45),
        rgba(78,240,181,.35),
        rgba(122,162,255,.55)
      );
      animation: blobA 14s ease-in-out infinite alternate;
    }
    .scene::after{
      right:-320px; bottom:-420px;
      background: conic-gradient(from 210deg,
        rgba(78,240,181,.45),
        rgba(122,162,255,.45),
        rgba(255,211,106,.22),
        rgba(78,240,181,.45)
      );
      animation: blobB 16s ease-in-out infinite alternate;
      opacity:.50;
    }
    .aurora{
      position:fixed; inset:-20% -10%;
      z-index:-2;
      pointer-events:none;
      opacity:.55;
      filter: blur(40px) saturate(1.1);
      background:
        radial-gradient(800px 420px at 20% 20%, rgba(122,162,255,.28), transparent 60%),
        radial-gradient(720px 420px at 80% 30%, rgba(78,240,181,.18), transparent 62%),
        radial-gradient(760px 480px at 55% 80%, rgba(179,140,255,.16), transparent 62%);
      animation: aurora 10s ease-in-out infinite alternate;
      transform: translate3d(0,0,0);
    }
    .grain{
      position:fixed; inset:-50px; z-index:-1; pointer-events:none;
      opacity:.08;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".9" numOctaves="4" stitchTiles="stitch"/></filter><rect width="140" height="140" filter="url(%23n)" opacity=".55"/></svg>');
      background-size: 220px 220px;
      mix-blend-mode: overlay;
    }
    @keyframes blobA{ from{ transform: translate3d(0,0,0) rotate(0deg); } to{ transform: translate3d(180px,120px,0) rotate(35deg); } }
    @keyframes blobB{ from{ transform: translate3d(0,0,0) rotate(0deg); } to{ transform: translate3d(-180px,-140px,0) rotate(-30deg); } }
    @keyframes aurora{ from{ transform: translate3d(-1%, -1%, 0) scale(1.02); } to{ transform: translate3d(2%, 1%, 0) scale(1.06); } }
    @media (prefers-reduced-motion: reduce){
      .scene::before,.scene::after,.aurora{ animation:none !important; }
      *{ transition:none !important; animation:none !important; }
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:60;
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-bottom:1px solid var(--stroke2);
    }
    html[data-theme="light"] header{ background: rgba(255,255,255,.62); }

    .topbar{
      max-width:1100px; margin:0 auto;
      padding:12px 14px;
      display:flex; align-items:center; gap:10px;
    }
    .brand{min-width:0; display:flex; flex-direction:column}
    .brand .t{
      font-family: var(--font-display);
      font-weight:900;
      font-size:16px;
      letter-spacing:-.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:64vw;
      background: linear-gradient(90deg, rgba(122,162,255,1), rgba(78,240,181,1), rgba(179,140,255,1));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      text-shadow: 0 10px 22px rgba(0,0,0,.20);
    }
    html[data-theme="light"] .brand .t{ text-shadow:none; filter:saturate(1.05); }
    .brand .s{color:var(--muted); font-size:12px; margin-top:3px; letter-spacing:-.1px;}
    .spacer{margin-inline-start:auto}

    /* Buttons */
    .btn{
      position:relative;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text);
      border-radius: 18px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      min-height:44px;
      box-shadow: 0 12px 28px rgba(0,0,0,.18);
      transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      overflow:hidden;
      text-decoration:none;
      font-family: inherit;
    }
    .btn::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(420px 120px at 30% 0%, rgba(255,255,255,.18), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .btn:hover{ filter:brightness(1.06) }
    .btn:active{ transform: translateY(1px) scale(.99) }
    .btn.primary{ border-color: rgba(122,162,255,.78); background: linear-gradient(180deg, rgba(122,162,255,.32), rgba(122,162,255,.14)); }
    .btn.danger{ border-color: rgba(255,107,134,.72); background: linear-gradient(180deg, rgba(255,107,134,.28), rgba(255,107,134,.12)); }
    .btn.ghost{ box-shadow:none; background: rgba(255,255,255,.06); }
    .btn.icon{width:44px; padding:10px}

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: 999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.good{border-color: rgba(78,240,181,.45); background: rgba(78,240,181,.12);}
    .pill.bad{border-color: rgba(255,107,134,.55); background: rgba(255,107,134,.12); color:var(--text);}
    .pill.warn{border-color: rgba(255,211,106,.55); background: rgba(255,211,106,.12); color:var(--text);}

    /* Layout */
    main{max-width:1100px; margin:0 auto; padding:14px;}
    .grid2{display:grid; grid-template-columns: 1fr; gap:12px; align-items:start}
    @media(min-width:980px){ .grid2{grid-template-columns: 1.2fr .8fr} }

    .view{display:none}
    .view.active{display:block; animation: pop .16s ease both}
    @keyframes pop{ from{opacity:0; transform: translateY(6px) scale(.995)} to{opacity:1; transform:none} }

    /* Cards */
    .card{
      position:relative;
      background: var(--card);
      border:1px solid transparent;
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      padding:1px;
      border-radius: inherit;
      background: linear-gradient(135deg,
        rgba(122,162,255,.55),
        rgba(78,240,181,.35),
        rgba(179,140,255,.35),
        rgba(255,255,255,.10)
      );
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.45;
    }
    .card.soft{
      background: var(--card2);
      box-shadow:none;
      border:1px solid var(--stroke);
    }
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .small{font-size:12px}
    .hr{height:1px; background: var(--stroke); margin:12px 0; opacity:.85}

    label.field{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}

    input[type="text"], input[type="tel"], input[type="search"], input[type="number"], textarea, select{
      width:100%;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--text);
      border-radius: 18px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
      font-family: inherit;
      transition: box-shadow .12s ease, border-color .12s ease, filter .12s ease;
    }
    input::placeholder, textarea::placeholder{ color: var(--muted2); }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(122,162,255,.80);
      box-shadow: 0 0 0 4px rgba(122,162,255,.16);
    }
    select{cursor:pointer}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    .row.compact > *{flex:0 0 auto}

    /* Pretty toggles */
    .ctrlGroup{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: 20px;
      padding:10px;
      display:flex; flex-wrap:wrap; gap:10px;
      position:relative;
    }
    .ctrlGroup input[type="checkbox"],
    .ctrlGroup input[type="radio"]{
      position:absolute;
      opacity:0;
      width:1px; height:1px;
      pointer-events:none;
    }
    .ctrl{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: 20px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      min-height:44px;
      position:relative;
      padding-inline-start:46px;
      transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
    }
    label.ctrl::before{
      content:"";
      position:absolute;
      inset-inline-start:14px;
      top:50%;
      transform:translateY(-50%);
      width:18px; height:18px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: 7px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .ctrlGroup input[type="radio"] + label.ctrl::before{ border-radius: 999px; }
    .ctrlGroup input:checked + label.ctrl{
      border-color: rgba(122,162,255,.82);
      background: linear-gradient(180deg, rgba(122,162,255,.28), rgba(122,162,255,.10));
      filter: brightness(1.03);
    }
    .ctrlGroup input:checked + label.ctrl::before{
      border-color: rgba(122,162,255,.96);
      background: rgba(122,162,255,.34);
      box-shadow: 0 0 0 4px rgba(122,162,255,.12), inset 0 1px 0 rgba(255,255,255,.14);
    }
    .ctrlGroup input[type="checkbox"]:checked + label.ctrl::after{
      content:"âœ“";
      position:absolute;
      inset-inline-start:18px;
      top:50%;
      transform:translateY(-52%);
      font-weight:900;
      font-size:13px;
      color:var(--text);
    }
    .ctrlGroup input[type="radio"]:checked + label.ctrl::after{
      content:"";
      position:absolute;
      inset-inline-start:19px;
      top:50%;
      transform:translateY(-50%);
      width:10px; height:10px;
      border-radius:999px;
      background: var(--text);
    }

    /* List items */
    .list{display:grid; grid-template-columns: 1fr; gap:10px}
    @media(min-width:980px){ .list{grid-template-columns: 1fr 1fr} }

    .item{
      position:relative;
      overflow:hidden;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: 24px;
      padding:12px;
      box-shadow: var(--shadowSoft);
      transition: transform .12s ease, filter .12s ease;
    }
    .item:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .item::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(520px 180px at 85% 16%, rgba(122,162,255,.16), transparent 60%),
        radial-gradient(420px 220px at 20% 95%, rgba(78,240,181,.10), transparent 62%);
      pointer-events:none;
    }
    .item::after{
      content:"";
      position:absolute;
      top:14px; bottom:14px;
      inset-inline-start:14px;
      width:4px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(78,240,181,.55), rgba(179,140,255,.55));
      opacity:.92;
      pointer-events:none;
    }
    .item h4{
      margin:0;
      font-family: var(--font-display);
      font-size:15.5px;
      line-height:1.65;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .item .sub{margin-top:6px; color:var(--muted); font-size:12.8px; line-height:1.95}
    .item .meta{display:flex; flex-wrap:wrap; gap:6px; margin-top:10px}
    .item .btns{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .item .btns .btn{box-shadow:none}
    .item .btns .btn.ghost{background: rgba(255,255,255,.06)}

    .priceTag{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:900;
      font-size:12px;
    }
    .priceTag .k{ color: var(--muted); font-weight:800; }

    .empty{
      padding:16px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 24px;
      color:var(--muted);
      text-align:center;
      background: rgba(255,255,255,.03);
    }
    .empty .emoji{font-size:26px; margin-bottom:6px}

    /* Drawer */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition:.2s ease;
      z-index:80;
    }
    .overlay.show{opacity:1; pointer-events:auto}
    .drawer{
      position:fixed; top:0; bottom:0; right:0;
      width: min(var(--drawerW), 86vw);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-left:1px solid var(--stroke2);
      box-shadow: var(--shadow);
      transform: translateX(105%);
      transition:.22s ease;
      z-index:90;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    html[data-theme="light"] .drawer{ background: rgba(255,255,255,.55); }
    .drawer.show{transform: translateX(0)}
    .navBtn{
      width:100%;
      justify-content:flex-start;
      padding:12px 12px;
      border-radius: 20px;
      box-shadow:none;
      background: rgba(255,255,255,.05);
    }
    .navBtn.active{
      border-color: rgba(122,162,255,.80);
      background: linear-gradient(180deg, rgba(122,162,255,.26), rgba(122,162,255,.10));
    }
    @media(min-width:980px){
      .overlay{display:none !important}
      .drawer{
        position:sticky; top:84px;
        transform:none !important;
        width: 340px;
        height: calc(100vh - 110px);
        border-radius: 24px;
        background: var(--card2);
        backdrop-filter:none;
        -webkit-backdrop-filter:none;
      }
      #btnDrawer{display:none}
      body{ padding-bottom: 24px; }
      .bottomNav{display:none !important}
    }

    /* Bottom Nav (6 items now) */
    .bottomNav{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index:120;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      border-radius: 24px;
      padding:10px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
    }
    html[data-theme="light"] .bottomNav{ background: rgba(255,255,255,.62); }
    .bNavBtn{
      border:1px solid transparent;
      background: rgba(255,255,255,.05);
      color: var(--muted);
      border-radius: 20px;
      min-height: 52px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      transition:.12s ease;
      font-family: inherit;
    }
    .bNavBtn .i{font-size:18px; line-height:1}
    .bNavBtn .t{font-size:11px}
    .bNavBtn.active{
      color: var(--text);
      border-color: rgba(122,162,255,.65);
      background: linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.10));
    }

    /* Toast + errors + banner */
    .toast{
      position:fixed;
      right:14px;
      bottom: calc(104px + env(safe-area-inset-bottom));
      z-index:200;
      background: linear-gradient(180deg, rgba(0,0,0,.52), rgba(0,0,0,.34));
      border:1px solid var(--stroke2);
      border-radius: 18px;
      padding:10px 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,.30);
      display:none;
      max-width: 92vw;
    }
    html[data-theme="light"] .toast{ background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.72)); }
    .toast.show{display:block}
    .toast b{display:block}
    .toast small{color:var(--muted)}

    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,107,134,.55);
      background: rgba(255,107,134,.12);
      color:var(--text);
      display:none;
    }
    .err.show{display:block}

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      line-height:1.95;
    }

    textarea.contract{min-height:280px; line-height:2.0; resize:vertical;}

    /* Dashboard Pack */
    .dashWrap{
      margin-top: 10px;
      padding: 12px;
      border-radius: 24px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.035);
    }
    .dashHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;}
    .dashTitle{font-family: var(--font-display); font-weight: 900; font-size: 14.5px;}
    .dashHint{color: var(--muted); font-size: 12px; white-space: nowrap;}

    .kpiGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media(min-width:980px){ .kpiGrid{ grid-template-columns: repeat(4, 1fr); } }
    .kpi{
      position:relative; overflow:hidden;
      border-radius: 22px;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadowSoft);
      padding: 12px;
      display:flex; gap:10px; align-items:center;
    }
    .kpi::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(280px 120px at 85% 15%, rgba(122,162,255,.20), transparent 65%),
        radial-gradient(260px 140px at 15% 90%, rgba(78,240,181,.12), transparent 60%);
      pointer-events:none;
    }
    .kpiIcon{
      width:44px; height:44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      font-size:20px;
      flex:0 0 auto;
    }
    .kpiBody{ min-width:0; }
    .kpiT{ color: var(--muted); font-size: 12px; font-weight:800; }
    .kpiV{ font-family: var(--font-display); font-size: 20px; font-weight: 900; letter-spacing: -.2px; margin-top: 2px; }
    .kpiS{ color: var(--muted2); font-size: 12px; margin-top: 2px; }

    .dashGrid2{display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 10px;}
    @media(min-width:980px){ .dashGrid2{ grid-template-columns: 1fr 1fr; } }

    .dashCard{border-radius: 24px; border:1px solid var(--stroke2); background: rgba(255,255,255,.04); padding: 12px;}
    .dashCardT{font-family: var(--font-display); font-weight: 900; font-size: 13.5px; margin-bottom: 10px;}

    .barRow{display:grid; grid-template-columns: 86px 1fr 54px; gap:10px; align-items:center; margin: 10px 0;}
    .barLbl{ color: var(--muted); font-size: 12px; font-weight:800; }
    .barVal{ text-align:left; font-size:12px; color: var(--text); }
    .barTrack{height: 10px; border-radius: 999px; border: 1px solid var(--stroke2); background: rgba(255,255,255,.04); overflow:hidden;}
    .barFill{height: 100%; width: 0%; border-radius: 999px; background: linear-gradient(90deg, rgba(122,162,255,.95), rgba(78,240,181,.65), rgba(179,140,255,.65)); transition: width .18s ease;}

    .rankList, .recentList{ display:flex; flex-direction:column; gap:8px; }
    .rankItem, .recentItem{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .rankLeft, .recentLeft{ min-width:0; }
    .rankName, .recentName{
      font-weight:900;
      font-size: 12.5px;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rankMeta, .recentMeta{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .badgeNum{
      flex:0 0 auto;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 900;
      font-size: 12px;
    }
    .dashEmpty{
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      padding: 10px;
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 18px;
      background: rgba(255,255,255,.02);
    }

    /* Search Advanced Filters */
    .filterPanel{
      margin-top: 12px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: 24px;
      padding: 12px;
    }
    .filterHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;}
    .filterTitle{font-family: var(--font-display); font-weight: 900; font-size: 13.5px;}
    .filterGrid{display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 10px;}
    @media(min-width:980px){
      .filterGrid.cols2{ grid-template-columns: 1fr 1fr; }
      .filterGrid.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }
    .miniHint{color: var(--muted2); font-size: 12px; margin-top: 6px; line-height: 1.9;}
    .filterLine{border-top:1px solid var(--stroke); margin:12px 0; opacity:.85}
  </style>
</head>

<body>
  <div class="scene" aria-hidden="true"></div>
  <div class="aurora" aria-hidden="true"></div>
  <div class="grain" aria-hidden="true"></div>

<header>
  <div class="topbar">
    <button class="btn icon ghost" id="btnDrawer" type="button" aria-label="Ù…Ù†Ùˆ">â˜°</button>

    <div class="brand">
      <div class="t">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù„Ø§Ú© â€” Ultra</div>
      <div class="s">Ù¾Ø±ÛŒÙ…ÛŒÙˆÙ… â€¢ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€¢ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</div>
    </div>

    <div class="spacer"></div>

    <span class="pill" id="storeStatus">â€¦</span>
    <button class="btn ghost" id="btnTheme" type="button">ğŸŒ“ ØªÙ…</button>
  </div>
</header>

<div class="overlay" id="overlay"></div>

<aside class="drawer" id="drawer">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
    <b style="font-family:var(--font-display)">Ù…Ù†Ùˆ</b>
    <button class="btn icon danger" id="btnClose" type="button" aria-label="Ø¨Ø³ØªÙ†">âœ•</button>
  </div>

  <div class="card soft">
    <button class="btn navBtn active" data-go="saved" type="button">ğŸ“Œ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
    <button class="btn navBtn" data-go="dashboard" type="button">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
    <button class="btn navBtn" data-go="new" type="button">ğŸ“ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
    <button class="btn navBtn" data-go="search" type="button">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
    <button class="btn navBtn" data-go="contract" type="button">ğŸ“„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
    <button class="btn navBtn" data-go="settings" type="button">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
  </div>

  <div class="card soft" style="margin-top:auto">
    <div class="muted small">ØªÙ… Ø³Ø±ÛŒØ¹:</div>
    <div class="row compact" style="gap:8px; margin-top:10px">
      <button class="btn ghost" data-theme="dark" type="button">Dark</button>
      <button class="btn ghost" data-theme="light" type="button">Light</button>
    </div>
  </div>
</aside>

<main>
  <div class="grid2">
    <div>

      <!-- SAVED -->
      <section class="view active" id="view-saved">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div>
              <div style="font-family:var(--font-display); font-weight:900; font-size:15px">Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</div>
              <div class="muted small" id="savedCount">0 Ù…ÙˆØ±Ø¯</div>
            </div>
            <div class="row compact" style="gap:8px">
              <button class="btn ghost" data-go="dashboard" type="button">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
              <button class="btn primary" data-go="new" type="button">ï¼‹ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Dashboard mounts here when on Saved -->
          <div id="dashMountSaved"></div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label class="field">Ø¬Ø³ØªØ¬Ùˆ (Ù…Ù†Ø·Ù‚Ù‡/Ù…ÙˆÙ‚Ø¹ÛŒØª/Ù†Ø§Ù…/ØªÙ„ÙÙ†)</label>
              <input id="sQ" type="search" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ù†Ø·Ù‚Ù‡ Û²ØŒ Ú¯ÙˆÙ‡Ø±Ø¯Ø´ØªØŒ Ø¹Ù„ÛŒØŒ 0912..." />
            </div>
            <div>
              <label class="field">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</label>
              <select id="sSort">
                <option value="new" selected>Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
                <option value="old">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</option>
                <option value="priceAsc">Ù‚ÛŒÙ…Øª â†‘</option>
                <option value="priceDesc">Ù‚ÛŒÙ…Øª â†“</option>
                <option value="areaAsc">Ù…ØªØ±Ø§Ú˜ â†‘</option>
                <option value="areaDesc">Ù…ØªØ±Ø§Ú˜ â†“</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="list" id="savedList"></div>

          <div class="empty" id="savedEmpty" style="display:none; margin-top:10px">
            <div class="emoji">ğŸ“­</div>
            Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡. Ø§Ø² Â«Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒÂ» Ø´Ø±ÙˆØ¹ Ú©Ù†.
          </div>
        </div>
      </section>

      <!-- DASHBOARD (new dedicated view) -->
      <section class="view" id="view-dashboard">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div>
              <div style="font-family:var(--font-display); font-weight:900; font-size:15px">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</div>
              <div class="muted small">Ø¢Ù…Ø§Ø±ØŒ ØªØ±Ú©ÛŒØ¨â€ŒÙ‡Ø§ Ùˆ Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</div>
            </div>
            <div class="row compact" style="gap:8px">
              <button class="btn ghost" data-go="saved" type="button">ğŸ“Œ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
              <button class="btn primary" data-go="new" type="button">ï¼‹ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Dashboard mounts here when on Dashboard -->
          <div id="dashMountDashboard"></div>
        </div>
      </section>

      <!-- NEW -->
      <section class="view" id="view-new">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div>
              <div style="font-family:var(--font-display); font-weight:900; font-size:15px">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</div>
              <div class="muted small" id="editHint"></div>
            </div>
            <button class="btn ghost" data-go="saved" type="button">ğŸ“Œ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
          </div>

          <div class="banner" id="lastAction">Ø¢Ø®Ø±ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª: â€”</div>

          <div class="hr"></div>

          <form id="form" novalidate>
            <!-- Change: Title -> Region -->
            <label class="field">Ù…Ù†Ø·Ù‚Ù‡ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
            <input id="fTitle" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ù†Ø·Ù‚Ù‡ Û² / Ú¯ÙˆÙ‡Ø±Ø¯Ø´Øª / Ø¹Ø¸ÛŒÙ…ÛŒÙ‡..." />

            <div class="row">
              <div>
                <label class="field">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÙØ±Ø¯ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                <input id="fPerson" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ" />
              </div>
              <div>
                <label class="field">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ÙØ±Ø¯ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                <input id="fPhone" type="tel" inputmode="tel" placeholder="Ù…Ø«Ù„Ø§Ù‹: 0912xxxxxxx" />
              </div>
            </div>

            <label class="field">Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
            <div class="ctrlGroup">
              <input type="radio" id="deal_rent" name="deal" value="rent" checked>
              <label class="ctrl" for="deal_rent">ğŸ  Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡</label>

              <input type="radio" id="deal_sale" name="deal" value="sale">
              <label class="ctrl" for="deal_sale">ğŸ·ï¸ Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´</label>
            </div>

            <label class="field">Ù†ÙˆØ¹ Ù…Ù„Ú© (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
            <div class="ctrlGroup">
              <input type="radio" id="t_com" name="type" value="commercial" checked>
              <label class="ctrl" for="t_com">ğŸ¬ ØªØ¬Ø§Ø±ÛŒ</label>

              <input type="radio" id="t_res" name="type" value="residential">
              <label class="ctrl" for="t_res">ğŸ¡ Ù…Ø³Ú©ÙˆÙ†ÛŒ</label>

              <input type="radio" id="t_sto" name="type" value="storage">
              <label class="ctrl" for="t_sto">ğŸ“¦ Ø§Ù†Ø¨Ø§Ø±ÛŒ</label>

              <input type="radio" id="t_gar" name="type" value="gardenhouse">
              <label class="ctrl" for="t_gar">ğŸŒ¿ Ø®ÙˆÙ†Ù‡ Ø¨Ø§Øº</label>
            </div>

            <div id="resSubWrap" style="display:none">
              <label class="field">Ø²ÛŒØ±Ù†ÙˆØ¹ Ù…Ø³Ú©ÙˆÙ†ÛŒ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
              <div class="ctrlGroup">
                <input type="radio" id="rs_ap" name="resSub" value="apartment" checked>
                <label class="ctrl" for="rs_ap">ğŸ¢ Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ</label>

                <input type="radio" id="rs_vi" name="resSub" value="villa">
                <label class="ctrl" for="rs_vi">ğŸ˜ï¸ ÙˆÛŒÙ„Ø§ÛŒÛŒ</label>
              </div>
            </div>

            <div class="row">
              <div>
                <label class="field">Ù…ÙˆÙ‚Ø¹ÛŒØª (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                <input id="fLocation" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú©Ø±Ø¬ØŒ Ú¯ÙˆÙ‡Ø±Ø¯Ø´Øª..." />
              </div>
              <div>
                <label class="field">Ù…ØªØ±Ø§Ú˜ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                <input id="fArea" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 300" />
              </div>
            </div>

            <div id="priceRentBox">
              <label class="field">Ù…Ø¨Ø§Ù„Øº Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡</label>
              <div class="row">
                <div>
                  <label class="field">Ù…Ø¨Ù„Øº Ø±Ù‡Ù† / ÙˆØ¯ÛŒØ¹Ù‡ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                  <input id="fDeposit" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 500000000" />
                </div>
                <div>
                  <label class="field">Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ / ÛŒØ§ 0 Ø¨Ø±Ø§ÛŒ Ø±Ù‡Ù† Ú©Ø§Ù…Ù„)</label>
                  <input id="fMonthly" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 15000000" />
                </div>
                <div>
                  <label class="field">Ø¨ÛŒØ¹Ø§Ù†Ù‡ / Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                  <input id="fBayaneRent" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 20000000" />
                </div>
              </div>
            </div>

            <div id="priceSaleBox" style="display:none">
              <label class="field">Ù…Ø¨Ø§Ù„Øº Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´</label>
              <div class="row">
                <div>
                  <label class="field">Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                  <input id="fSalePrice" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 3500000000" />
                </div>
                <div>
                  <label class="field">Ø¨ÛŒØ¹Ø§Ù†Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                  <input id="fBayaneSale" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 100000000" />
                </div>
              </div>
            </div>

            <label class="field">Ø¨Ø±Ù‚</label>
            <div class="ctrlGroup">
              <input type="radio" id="e_single" name="elec" value="single" checked>
              <label class="ctrl" for="e_single">âš¡ ØªÚ© ÙØ§Ø²</label>

              <input type="radio" id="e_three" name="elec" value="three">
              <label class="ctrl" for="e_three">âš¡âš¡âš¡ Ø³Ù‡ ÙØ§Ø²</label>
            </div>

            <label class="field">Ø¢Ù¾Ø´Ù†â€ŒÙ‡Ø§</label>
            <div class="ctrlGroup">
              <input type="checkbox" id="o_key">
              <label class="ctrl" for="o_key">ğŸ”‘ Ú©Ù„ÛŒØ¯ Ø§ÙˆÙ„</label>

              <input type="checkbox" id="o_kol">
              <label class="ctrl" for="o_kol">ğŸ§± Ú©Ù„Ù†Ú¯ÛŒ</label>

              <input type="checkbox" id="o_full">
              <label class="ctrl" for="o_full">âœ¨ ÙÙˆÙ„ Ø§Ù…Ú©Ø§Ù†Ø§Øª</label>
            </div>

            <label class="field">Ø§Ù…Ú©Ø§Ù†Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <div class="ctrlGroup">
              <input type="checkbox" class="amen" id="a1" value="Ú©Ù…Ø¯ Ùˆ Ú©Ø§Ø¨ÛŒÙ†Øª"><label class="ctrl" for="a1">ğŸ§° Ú©Ù…Ø¯ Ùˆ Ú©Ø§Ø¨ÛŒÙ†Øª</label>
              <input type="checkbox" class="amen" id="a2" value="Ú¯Ø§Ø² Ø´Ù‡Ø±ÛŒ"><label class="ctrl" for="a2">ğŸ”¥ Ú¯Ø§Ø² Ø´Ù‡Ø±ÛŒ</label>
              <input type="checkbox" class="amen" id="a3" value="Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯"><label class="ctrl" for="a3">ğŸš— Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯</label>
              <input type="checkbox" class="amen" id="a4" value="Ø¢Ø³Ø§Ù†Ø³ÙˆØ±"><label class="ctrl" for="a4">ğŸ›— Ø¢Ø³Ø§Ù†Ø³ÙˆØ±</label>
              <input type="checkbox" class="amen" id="a5" value="Ú©ÙˆÙ„Ø±"><label class="ctrl" for="a5">â„ï¸ Ú©ÙˆÙ„Ø±</label>
              <input type="checkbox" class="amen" id="a6" value="Ù¾Ú©ÛŒØ¬/Ø´ÙˆÙØ§Ú˜"><label class="ctrl" for="a6">â™¨ï¸ Ù¾Ú©ÛŒØ¬/Ø´ÙˆÙØ§Ú˜</label>
              <input type="checkbox" class="amen" id="a7" value="Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ"><label class="ctrl" for="a7">ğŸ›¡ï¸ Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ</label>
            </div>

            <label class="field">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <textarea id="fDesc" rows="3" placeholder="Ù†Ú©ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…â€¦"></textarea>

            <div class="hr"></div>

            <button class="btn primary" id="btnSave" type="button" style="width:100%; min-height:56px; font-size:15px">
              âœ… Ø°Ø®ÛŒØ±Ù‡ Ø¢Ú¯Ù‡ÛŒ
            </button>

            <div class="row compact" style="gap:8px; margin-top:10px">
              <button class="btn ghost" type="button" id="btnClear">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
              <button class="btn danger" type="button" id="btnCancelEdit" style="display:none">âœ–ï¸ Ù„ØºÙˆ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            </div>

            <div class="err" id="formErr"></div>
          </form>
        </div>
      </section>

      <!-- SEARCH -->
      <section class="view" id="view-search">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div>
              <div style="font-family:var(--font-display); font-weight:900; font-size:15px">Ø¬Ø³ØªØ¬Ùˆ</div>
              <div class="muted small" id="searchCount">0 Ù…ÙˆØ±Ø¯</div>
            </div>
            <button class="btn ghost" id="btnResetSearch" type="button">â†º Ø±ÛŒØ³Øª</button>
          </div>

          <div class="hr"></div>

          <label class="field">Ø¬Ø³ØªØ¬Ùˆ Ú©Ù„ÛŒ (Ù…Ù†Ø·Ù‚Ù‡/Ù…ÙˆÙ‚Ø¹ÛŒØª/Ù†Ø§Ù…/ØªÙ„ÙÙ†)</label>
          <input id="q" type="search" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ù†Ø·Ù‚Ù‡ Û²ØŒ Ú¯ÙˆÙ‡Ø±Ø¯Ø´ØªØŒ Ø¹Ù„ÛŒØŒ 0912..." />

          <div class="filterPanel" id="filterPanel">
            <div class="filterHead">
              <div class="filterTitle">ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</div>
              <div class="row compact" style="gap:8px">
                <button class="btn ghost" id="btnClearFilters" type="button">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
              </div>
            </div>

            <div class="filterGrid cols3">
              <div>
                <label class="field">Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡</label>
                <select id="sfDeal">
                  <option value="any" selected>Ù‡Ù…Ù‡</option>
                  <option value="rent">Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡</option>
                  <option value="sale">Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´</option>
                </select>
              </div>

              <div>
                <label class="field">Ù†ÙˆØ¹ Ù…Ù„Ú©</label>
                <select id="sfType">
                  <option value="any" selected>Ù‡Ù…Ù‡</option>
                  <option value="commercial">ØªØ¬Ø§Ø±ÛŒ</option>
                  <option value="residential">Ù…Ø³Ú©ÙˆÙ†ÛŒ</option>
                  <option value="storage">Ø§Ù†Ø¨Ø§Ø±ÛŒ</option>
                  <option value="gardenhouse">Ø®ÙˆÙ†Ù‡ Ø¨Ø§Øº</option>
                </select>
              </div>

              <div id="sfResSubWrap" style="display:none">
                <label class="field">Ø²ÛŒØ±Ù†ÙˆØ¹ Ù…Ø³Ú©ÙˆÙ†ÛŒ</label>
                <select id="sfResSub">
                  <option value="any" selected>Ù‡Ù…Ù‡</option>
                  <option value="apartment">Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ</option>
                  <option value="villa">ÙˆÛŒÙ„Ø§ÛŒÛŒ</option>
                </select>
              </div>
            </div>

            <div class="filterLine"></div>

            <div class="filterGrid cols2">
              <div>
                <label class="field">Ù…ØªØ±Ø§Ú˜ Ø§Ø²</label>
                <input id="sfAreaMin" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 100" />
              </div>
              <div>
                <label class="field">Ù…ØªØ±Ø§Ú˜ ØªØ§</label>
                <input id="sfAreaMax" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 500" />
              </div>
            </div>

            <div class="filterGrid cols2">
              <div>
                <label class="field" id="sfPriceMinLabel">Ù‚ÛŒÙ…Øª/Ø±Ù‡Ù† Ø§Ø²</label>
                <input id="sfPriceMin" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 500000000" />
              </div>
              <div>
                <label class="field" id="sfPriceMaxLabel">Ù‚ÛŒÙ…Øª/Ø±Ù‡Ù† ØªØ§</label>
                <input id="sfPriceMax" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 3000000000" />
              </div>
            </div>

            <div id="sfRentOnly" style="display:none">
              <div class="filterGrid cols2">
                <div>
                  <label class="field">Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§Ø²</label>
                  <input id="sfMonthlyMin" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 0" />
                </div>
                <div>
                  <label class="field">Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ ØªØ§</label>
                  <input id="sfMonthlyMax" type="number" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹: 25000000" />
                </div>
              </div>
              <div class="miniHint">Ø§Ú¯Ø± Â«Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡Â» Ø±ÙˆÛŒ â€œØ±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡â€ Ø¨Ø§Ø´Ø¯ØŒ Ø§ÛŒÙ† ÙÛŒÙ„ØªØ± ÙØ¹Ø§Ù„ Ø§Ø³Øª.</div>
            </div>

            <div class="filterLine"></div>

            <label class="field">Ø¢Ù¾Ø´Ù†â€ŒÙ‡Ø§</label>
            <div class="ctrlGroup">
              <input type="checkbox" id="sfKey"><label class="ctrl" for="sfKey">ğŸ”‘ Ú©Ù„ÛŒØ¯ Ø§ÙˆÙ„</label>
              <input type="checkbox" id="sfKol"><label class="ctrl" for="sfKol">ğŸ§± Ú©Ù„Ù†Ú¯ÛŒ</label>
              <input type="checkbox" id="sfFull"><label class="ctrl" for="sfFull">âœ¨ ÙÙˆÙ„ Ø§Ù…Ú©Ø§Ù†Ø§Øª</label>
            </div>

            <label class="field">Ø§Ù…Ú©Ø§Ù†Ø§Øª (Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ØªØ§ÛŒÛŒ)</label>
            <div class="ctrlGroup">
              <input type="checkbox" class="sfAmen" id="sa1" value="Ú©Ù…Ø¯ Ùˆ Ú©Ø§Ø¨ÛŒÙ†Øª"><label class="ctrl" for="sa1">ğŸ§° Ú©Ù…Ø¯ Ùˆ Ú©Ø§Ø¨ÛŒÙ†Øª</label>
              <input type="checkbox" class="sfAmen" id="sa2" value="Ú¯Ø§Ø² Ø´Ù‡Ø±ÛŒ"><label class="ctrl" for="sa2">ğŸ”¥ Ú¯Ø§Ø² Ø´Ù‡Ø±ÛŒ</label>
              <input type="checkbox" class="sfAmen" id="sa3" value="Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯"><label class="ctrl" for="sa3">ğŸš— Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯</label>
              <input type="checkbox" class="sfAmen" id="sa4" value="Ø¢Ø³Ø§Ù†Ø³ÙˆØ±"><label class="ctrl" for="sa4">ğŸ›— Ø¢Ø³Ø§Ù†Ø³ÙˆØ±</label>
              <input type="checkbox" class="sfAmen" id="sa5" value="Ú©ÙˆÙ„Ø±"><label class="ctrl" for="sa5">â„ï¸ Ú©ÙˆÙ„Ø±</label>
              <input type="checkbox" class="sfAmen" id="sa6" value="Ù¾Ú©ÛŒØ¬/Ø´ÙˆÙØ§Ú˜"><label class="ctrl" for="sa6">â™¨ï¸ Ù¾Ú©ÛŒØ¬/Ø´ÙˆÙØ§Ú˜</label>
              <input type="checkbox" class="sfAmen" id="sa7" value="Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ"><label class="ctrl" for="sa7">ğŸ›¡ï¸ Ù†Ú¯Ù‡Ø¨Ø§Ù†ÛŒ</label>
            </div>

            <div class="miniHint">
              Ù†Ú©ØªÙ‡: Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Â«Ù‡Ù…Ù‡â€ŒÛŒ Ù…ÙˆØ§Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡Â» ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (AND).
            </div>
          </div>

          <div class="hr"></div>

          <div class="list" id="resultList"></div>
          <div class="empty" id="resultEmpty" style="display:none; margin-top:10px">
            <div class="emoji">ğŸ”</div>
            Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ Ø³Ø¨Ú©â€ŒØªØ± Ú©Ù† ÛŒØ§ Ø¹Ø¨Ø§Ø±Øª Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø²Ù†.
          </div>
        </div>
      </section>

      <!-- CONTRACT -->
      <section class="view" id="view-contract">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div>
              <div style="font-family:var(--font-display); font-weight:900; font-size:15px">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</div>
              <div class="muted small">Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ØŒ ÙÙ‚Ø· Ù†Ø§Ù… Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†.</div>
            </div>
            <div class="row compact" style="gap:8px">
              <button class="btn ghost" id="btnCopy" type="button">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label class="field">Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ú¯Ù‡ÛŒ</label>
              <select id="cListing"></select>
            </div>
            <div>
              <label class="field">Ù†Ø§Ù… Ù…Ø§Ù„Ú©/ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø² Ø¢Ú¯Ù‡ÛŒ)</label>
              <input id="cOwner" type="text" />
            </div>
            <div>
              <label class="field">Ù†Ø§Ù… Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ (ÙÙ‚Ø· Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†)</label>
              <input id="cOther" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ÛŒ" />
            </div>
          </div>

          <label class="field">Ù…ØªÙ† Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</label>
          <textarea id="cText" class="contract"></textarea>
          <div class="muted small" style="margin-top:10px">Ø§ÛŒÙ† Ù…ØªÙ† Ù‚Ø§Ù„Ø¨ Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø³ØªØ› Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø±Ø³Ù…ÛŒØŒ Ø¨Ø±Ø±Ø³ÛŒ Ø­Ù‚ÙˆÙ‚ÛŒ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="view" id="view-settings">
        <div class="card">
          <div style="font-family:var(--font-display); font-weight:900; font-size:15px">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
          <div class="muted small" id="debugLine">â€”</div>

          <div class="hr"></div>

          <div class="row compact" style="gap:8px">
            <button class="btn danger" id="btnWipe" type="button">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
          </div>

          <div class="banner" style="margin-top:12px">
            Ø§Ú¯Ø± â€œØ°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒâ€ Ø¨Ø³ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ ğŸŸ¡ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› ÙˆÙ„ÛŒ Ø¨Ø§Ø² Ù‡Ù… Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ ØªØ§ ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¨Ù†Ø¯ÛŒØŒ Ø¯Ø§Ø®Ù„ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
          </div>
        </div>
      </section>

    </div>

    <div></div>
  </div>
</main>

<!-- Bottom Navigation (mobile) -->
<nav class="bottomNav" aria-label="Ù†Ø§ÙˆØ¨Ø±ÛŒ" id="bottomNav">
  <button class="bNavBtn active" data-go="saved" type="button"><div class="i">ğŸ“Œ</div><div class="t">Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div></button>
  <button class="bNavBtn" data-go="dashboard" type="button"><div class="i">ğŸ“Š</div><div class="t">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div></button>
  <button class="bNavBtn" data-go="new" type="button"><div class="i">ğŸ“</div><div class="t">Ø«Ø¨Øª</div></button>
  <button class="bNavBtn" data-go="search" type="button"><div class="i">ğŸ”</div><div class="t">Ø¬Ø³ØªØ¬Ùˆ</div></button>
  <button class="bNavBtn" data-go="contract" type="button"><div class="i">ğŸ“„</div><div class="t">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</div></button>
  <button class="bNavBtn" data-go="settings" type="button"><div class="i">âš™ï¸</div><div class="t">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div></button>
</nav>

<div class="toast" id="toast">
  <b id="toastT"></b>
  <small id="toastS"></small>
</div>

<!-- SINGLE Dashboard Module (moved between mounts) -->
<div id="dashWrap" class="dashWrap" style="display:none">
  <div class="dashHead">
    <div class="dashTitle">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
    <div class="dashHint" id="dashHint">â€”</div>
  </div>

  <div class="kpiGrid">
    <div class="kpi">
      <div class="kpiIcon">ğŸ“Œ</div>
      <div class="kpiBody">
        <div class="kpiT">Ú©Ù„ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</div>
        <div class="kpiV" id="kpiTotal">0</div>
        <div class="kpiS" id="kpiTotalSub">â€”</div>
      </div>
    </div>

    <div class="kpi">
      <div class="kpiIcon">ğŸ </div>
      <div class="kpiBody">
        <div class="kpiT">Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡</div>
        <div class="kpiV" id="kpiRent">0</div>
        <div class="kpiS" id="kpiRentSub">â€”</div>
      </div>
    </div>

    <div class="kpi">
      <div class="kpiIcon">ğŸ·ï¸</div>
      <div class="kpiBody">
        <div class="kpiT">Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´</div>
        <div class="kpiV" id="kpiSale">0</div>
        <div class="kpiS" id="kpiSaleSub">â€”</div>
      </div>
    </div>

    <div class="kpi">
      <div class="kpiIcon">ğŸ“</div>
      <div class="kpiBody">
        <div class="kpiT">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…ØªØ±Ø§Ú˜</div>
        <div class="kpiV" id="kpiAvgArea">â€”</div>
        <div class="kpiS">Ù…ØªØ±</div>
      </div>
    </div>
  </div>

  <div class="dashGrid2">
    <div class="dashCard">
      <div class="dashCardT">ØªØ±Ú©ÛŒØ¨ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
      <div class="barRow">
        <span class="barLbl">Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡</span>
        <div class="barTrack"><div class="barFill" id="barDealRent"></div></div>
        <b class="barVal" id="valDealRent">0%</b>
      </div>
      <div class="barRow">
        <span class="barLbl">Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´</span>
        <div class="barTrack"><div class="barFill" id="barDealSale"></div></div>
        <b class="barVal" id="valDealSale">0%</b>
      </div>
    </div>

    <div class="dashCard">
      <div class="dashCardT">ØªØ±Ú©ÛŒØ¨ Ù†ÙˆØ¹ Ù…Ù„Ú©</div>
      <div class="barRow">
        <span class="barLbl">ØªØ¬Ø§Ø±ÛŒ</span>
        <div class="barTrack"><div class="barFill" id="barTypeCom"></div></div>
        <b class="barVal" id="valTypeCom">0%</b>
      </div>
      <div class="barRow">
        <span class="barLbl">Ù…Ø³Ú©ÙˆÙ†ÛŒ</span>
        <div class="barTrack"><div class="barFill" id="barTypeRes"></div></div>
        <b class="barVal" id="valTypeRes">0%</b>
      </div>
      <div class="barRow">
        <span class="barLbl">Ø§Ù†Ø¨Ø§Ø±ÛŒ</span>
        <div class="barTrack"><div class="barFill" id="barTypeSto"></div></div>
        <b class="barVal" id="valTypeSto">0%</b>
      </div>
      <div class="barRow">
        <span class="barLbl">Ø®ÙˆÙ†Ù‡ Ø¨Ø§Øº</span>
        <div class="barTrack"><div class="barFill" id="barTypeGar"></div></div>
        <b class="barVal" id="valTypeGar">0%</b>
      </div>
    </div>
  </div>

  <div class="dashGrid2">
    <div class="dashCard">
      <div class="dashCardT">Ù„ÙˆÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ØªÚ©Ø±Ø§Ø±</div>
      <div class="rankList" id="dashTopLocations"></div>
      <div class="dashEmpty" id="dashLocEmpty" style="display:none">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>
    </div>

    <div class="dashCard">
      <div class="dashCardT">Ø¢Ø®Ø±ÛŒÙ† Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</div>
      <div class="recentList" id="dashRecent"></div>
      <div class="dashEmpty" id="dashRecentEmpty" style="display:none">Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>
    </div>
  </div>
</div>

<script>
/* ===== Polyfills (old WebView) ===== */
(function(){
  if(!Element.prototype.matches){
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }
  if(!Element.prototype.closest){
    Element.prototype.closest = function(s){
      var el = this;
      while(el && el.nodeType === 1){
        if(el.matches(s)) return el;
        el = el.parentElement || el.parentNode;
      }
      return null;
    };
  }
})();

/* ===== Helpers ===== */
function $(s){ return document.querySelector(s); }
function $$(s){ return Array.from(document.querySelectorAll(s)); }

function toast(t, s){
  $("#toastT").textContent = t || "";
  $("#toastS").textContent = s || "";
  var el = $("#toast");
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(function(){ el.classList.remove("show"); }, 2400);
}
function esc(s){
  return String(s==null?"":s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function toEnglishDigits(str){
  var s = String(str==null?"":str);
  var fa = "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹";
  var ar = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
  var out = "";
  for(var i=0;i<s.length;i++){
    var ch = s[i];
    var fi = fa.indexOf(ch);
    var ai = ar.indexOf(ch);
    if(fi>=0) out += String(fi);
    else if(ai>=0) out += String(ai);
    else out += ch;
  }
  return out;
}
function parseMoney(input){
  var raw = toEnglishDigits(String(input==null?"":input)).trim();
  if(!raw) return null;
  var cleaned = raw.replace(/[,\sÙ¬]/g,"");
  var n = Number(cleaned);
  if(!isFinite(n) || n < 0) return null;
  return Math.floor(n);
}
function fmt(n){ return Number(n||0).toLocaleString("fa-IR"); }
function uid(){ return "lst_"+Date.now()+"_"+Math.random().toString(16).slice(2); }

function getRadio(name){
  var el = document.querySelector('input[name="'+name+'"]:checked');
  return el ? el.value : "";
}
function setRadio(name, value){
  var els = document.querySelectorAll('input[name="'+name+'"]');
  for(var i=0;i<els.length;i++){
    els[i].checked = (els[i].value === value);
  }
}

/* ===== Global JS error reporter ===== */
function setLastAction(text){
  var el = $("#lastAction");
  if(el) el.textContent = "Ø¢Ø®Ø±ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª: " + text;
}
window.addEventListener("error", function(ev){
  try{
    setLastAction("Ø®Ø·Ø§ÛŒ JS: " + (ev.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ"));
    toast("Ø®Ø·Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡", ev.message || "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ");
  }catch(e){}
});

/* ===== Force toggle labels (reliable) ===== */
document.addEventListener("click", function(e){
  var t = e.target;
  if(t && t.nodeType === 3) t = t.parentElement;
  var ctrl = t && t.closest ? t.closest(".ctrl") : null;
  if(!ctrl) return;

  e.preventDefault();

  var forId = ctrl.getAttribute("for");
  if(!forId) return;

  var inp = document.getElementById(forId);
  if(!inp || inp.disabled) return;

  if(inp.type==="checkbox") inp.checked = !inp.checked;
  else if(inp.type==="radio") inp.checked = true;

  inp.dispatchEvent(new Event("change", {bubbles:true}));
});

/* ===== Theme ===== */
var THEME_KEY="amlak_ultra_theme";
function setTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
}
function loadTheme(){
  try{ setTheme(localStorage.getItem(THEME_KEY) || "dark"); }
  catch(e){ setTheme("dark"); }
}
$("#btnTheme").addEventListener("click", function(){
  var cur = document.documentElement.getAttribute("data-theme") || "dark";
  setTheme(cur==="dark" ? "light" : "dark");
});
document.addEventListener("click", function(e){
  var th = e.target.closest ? e.target.closest("[data-theme]") : null;
  if(th){ e.preventDefault(); setTheme(th.getAttribute("data-theme")); }
});

/* ===== Drawer / Nav ===== */
function openDrawer(){ $("#drawer").classList.add("show"); $("#overlay").classList.add("show"); }
function closeDrawer(){ $("#drawer").classList.remove("show"); $("#overlay").classList.remove("show"); }
$("#btnDrawer").addEventListener("click", openDrawer);
$("#btnClose").addEventListener("click", closeDrawer);
$("#overlay").addEventListener("click", closeDrawer);

function setBottomNavActive(name){
  var btns = $$("#bottomNav [data-go]");
  for(var i=0;i<btns.length;i++){
    btns[i].classList.toggle("active", btns[i].getAttribute("data-go")===name);
  }
}
function setDrawerActive(name){
  var btns = $$("#drawer [data-go]");
  for(var i=0;i<btns.length;i++){
    btns[i].classList.toggle("active", btns[i].getAttribute("data-go")===name);
  }
}

/* ===== Dashboard Mount (IMPORTANT) ===== */
function mountDashboard(where){
  var dash = $("#dashWrap");
  var mSaved = $("#dashMountSaved");
  var mDash = $("#dashMountDashboard");
  if(!dash || !mSaved || !mDash) return;

  // show it and move
  dash.style.display = "";
  if(where==="dashboard") mDash.appendChild(dash);
  else mSaved.appendChild(dash);
}

function setActiveView(name){
  var views = $$(".view");
  for(var i=0;i<views.length;i++) views[i].classList.remove("active");
  var v = $("#view-"+name);
  if(v) v.classList.add("active");

  setDrawerActive(name);
  setBottomNavActive(name);

  closeDrawer();

  // mount dashboard in correct place
  if(name==="dashboard") mountDashboard("dashboard");
  else mountDashboard("saved");

  // refresh data renders
  if(name==="saved") renderSaved();
  if(name==="dashboard") renderDashboard();
  if(name==="search") renderSearch();
  if(name==="contract") renderContract();
  if(name==="settings") renderSettings();
}

document.addEventListener("click", function(e){
  var go = e.target.closest ? e.target.closest("[data-go]") : null;
  if(go){ e.preventDefault(); setActiveView(go.getAttribute("data-go")); }
});

/* ===== Storage ===== */
var APP_KEY="amlak_ultra_state";
var storageMode="memory";
var state = { listings: [] };

function canUseLocalStorage(){
  try{
    var k="__t";
    localStorage.setItem(k,"1");
    localStorage.removeItem(k);
    return true;
  }catch(e){ return false; }
}
function loadState(){
  if(canUseLocalStorage()){
    storageMode="localStorage";
    try{
      var raw = localStorage.getItem(APP_KEY);
      if(raw){
        var data = JSON.parse(raw);
        state.listings = Array.isArray(data.listings) ? data.listings : [];
      }
    }catch(e){
      state.listings = [];
    }
  }else{
    storageMode="memory";
    state.listings = [];
  }
}
function saveState(){
  if(storageMode!=="localStorage") return false;
  try{
    localStorage.setItem(APP_KEY, JSON.stringify({listings: state.listings}));
    return true;
  }catch(e){
    storageMode="memory";
    return false;
  }
}
function updateStoreStatus(){
  var el=$("#storeStatus");
  if(storageMode==="localStorage"){
    el.className="pill good";
    el.textContent="ğŸŸ¢ Ø°Ø®ÛŒØ±Ù‡ ÙØ¹Ø§Ù„";
  }else{
    el.className="pill bad";
    el.textContent="ğŸŸ¡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª";
  }
}

/* ===== Domain helpers ===== */
function dealText(d){ return d==="rent" ? "Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡" : "Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´"; }
function typeText(t){
  if(t==="commercial") return "ØªØ¬Ø§Ø±ÛŒ";
  if(t==="residential") return "Ù…Ø³Ú©ÙˆÙ†ÛŒ";
  if(t==="storage") return "Ø§Ù†Ø¨Ø§Ø±ÛŒ";
  return "Ø®ÙˆÙ†Ù‡ Ø¨Ø§Øº";
}
function resSubText(s){ return s==="villa" ? "ÙˆÛŒÙ„Ø§ÛŒÛŒ" : "Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†ÛŒ"; }
function mainMoneyLine(it){
  if(it.deal==="rent"){
    return "Ø±Ù‡Ù†: "+fmt(it.deposit)+" â€¢ Ø§Ø¬Ø§Ø±Ù‡: "+fmt(it.monthly) + (it.bayane!=null ? (" â€¢ Ø¨ÛŒØ¹Ø§Ù†Ù‡: "+fmt(it.bayane)) : "");
  }
  return "Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´: "+fmt(it.salePrice) + (it.bayane!=null ? (" â€¢ Ø¨ÛŒØ¹Ø§Ù†Ù‡: "+fmt(it.bayane)) : "");
}

/* ===== Dashboard logic ===== */
function pct(n, total){
  if(!total) return 0;
  return Math.round((n / total) * 100);
}
function setBar(fillId, valId, n, total){
  var p = pct(n, total);
  var f = document.getElementById(fillId);
  var v = document.getElementById(valId);
  if(f) f.style.width = p + "%";
  if(v) v.textContent = p + "%";
}
function groupCount(arr, keyFn){
  var m = {};
  for(var i=0;i<arr.length;i++){
    var k = (keyFn(arr[i]) || "").trim();
    if(!k) continue;
    m[k] = (m[k]||0) + 1;
  }
  return m;
}
function topEntries(mapObj, n){
  var arr = Object.keys(mapObj).map(function(k){ return {k:k, v: mapObj[k]}; });
  arr.sort(function(a,b){ return b.v - a.v; });
  return arr.slice(0, n);
}
function renderDashboard(){
  var all = state.listings.slice();
  var total = all.length;

  var rentCount = 0, saleCount = 0, sumArea = 0;
  var typeCom=0, typeRes=0, typeSto=0, typeGar=0;

  for(var i=0;i<all.length;i++){
    var it = all[i];
    if(it.deal==="rent") rentCount++;
    else if(it.deal==="sale") saleCount++;
    sumArea += Number(it.area||0);

    if(it.type==="commercial") typeCom++;
    else if(it.type==="residential") typeRes++;
    else if(it.type==="storage") typeSto++;
    else if(it.type==="gardenhouse") typeGar++;
  }

  var avgArea = total ? Math.round(sumArea/total) : 0;

  var elTotal = $("#kpiTotal"); if(elTotal) elTotal.textContent = total.toLocaleString("fa-IR");
  var elRent  = $("#kpiRent");  if(elRent)  elRent.textContent  = rentCount.toLocaleString("fa-IR");
  var elSale  = $("#kpiSale");  if(elSale)  elSale.textContent  = saleCount.toLocaleString("fa-IR");
  var elAvg   = $("#kpiAvgArea"); if(elAvg) elAvg.textContent = total ? avgArea.toLocaleString("fa-IR") : "â€”";

  var hint = $("#dashHint");
  if(hint){
    hint.textContent = total ? ("Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: " + new Date().toLocaleTimeString("fa-IR")) : "â€”";
  }

  var subTotal = $("#kpiTotalSub");
  if(subTotal) subTotal.textContent = storageMode==="localStorage" ? "Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ ÙØ¹Ø§Ù„" : "Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª (ØªØ§ Ø¨Ø³ØªÙ† ØµÙØ­Ù‡)";

  var rentSub = $("#kpiRentSub");
  if(rentSub) rentSub.textContent = total ? (pct(rentCount,total).toLocaleString("fa-IR")+"Ùª Ø§Ø² Ú©Ù„") : "â€”";

  var saleSub = $("#kpiSaleSub");
  if(saleSub) saleSub.textContent = total ? (pct(saleCount,total).toLocaleString("fa-IR")+"Ùª Ø§Ø² Ú©Ù„") : "â€”";

  setBar("barDealRent","valDealRent", rentCount, total);
  setBar("barDealSale","valDealSale", saleCount, total);

  setBar("barTypeCom","valTypeCom", typeCom, total);
  setBar("barTypeRes","valTypeRes", typeRes, total);
  setBar("barTypeSto","valTypeSto", typeSto, total);
  setBar("barTypeGar","valTypeGar", typeGar, total);

  var locMap = groupCount(all, function(it){ return it.location || ""; });
  var topLoc = topEntries(locMap, 4);
  var locBox = $("#dashTopLocations");
  var locEmpty = $("#dashLocEmpty");
  if(locBox){
    if(!topLoc.length){
      locBox.innerHTML = "";
      if(locEmpty) locEmpty.style.display = "";
    }else{
      if(locEmpty) locEmpty.style.display = "none";
      locBox.innerHTML = topLoc.map(function(x, idx){
        return ''+
          '<div class="rankItem">'+
            '<div class="rankLeft">'+
              '<div class="rankName">ğŸ“ '+esc(x.k)+'</div>'+
              '<div class="rankMeta">Ø±ØªØ¨Ù‡ '+(idx+1).toLocaleString("fa-IR")+'</div>'+
            '</div>'+
            '<div class="badgeNum">'+x.v.toLocaleString("fa-IR")+'</div>'+
          '</div>';
      }).join("");
    }
  }

  var recent = all.slice().sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); }).slice(0,4);
  var recBox = $("#dashRecent");
  var recEmpty = $("#dashRecentEmpty");
  if(recBox){
    if(!recent.length){
      recBox.innerHTML = "";
      if(recEmpty) recEmpty.style.display = "";
    }else{
      if(recEmpty) recEmpty.style.display = "none";
      recBox.innerHTML = recent.map(function(it){
        var m = it.deal==="rent" ? ("Ø±Ù‡Ù†: "+fmt(it.deposit)+" â€¢ Ø§Ø¬Ø§Ø±Ù‡: "+fmt(it.monthly)) : ("ÙØ±ÙˆØ´: "+fmt(it.salePrice));
        return ''+
          '<div class="recentItem">'+
            '<div class="recentLeft">'+
              '<div class="recentName">Ù…Ù†Ø·Ù‚Ù‡: '+esc(it.title)+'</div>'+
              '<div class="recentMeta">'+esc(it.location||"â€”")+' â€¢ '+esc(m)+'</div>'+
            '</div>'+
            '<div class="badgeNum">ğŸ“ '+fmt(it.area)+'</div>'+
          '</div>';
      }).join("");
    }
  }
}

/* ===== Form UI sync ===== */
function syncResidential(){
  $("#resSubWrap").style.display = (getRadio("type")==="residential") ? "" : "none";
}
function syncDealBoxes(){
  var d=getRadio("deal");
  $("#priceRentBox").style.display = (d==="rent") ? "" : "none";
  $("#priceSaleBox").style.display = (d==="sale") ? "" : "none";
}
document.addEventListener("change", function(e){
  if(e.target && e.target.name==="type") syncResidential();
  if(e.target && e.target.name==="deal") syncDealBoxes();
});
$("#o_full").addEventListener("change", function(){
  if($("#o_full").checked){
    var am = $$(".amen");
    for(var i=0;i<am.length;i++) am[i].checked=true;
  }
});

/* ===== Save / Edit ===== */
var editingId = null;

function showFormError(msg){
  var box=$("#formErr");
  if(!msg){
    box.classList.remove("show");
    box.textContent="";
    return;
  }
  box.textContent=msg;
  box.classList.add("show");
}
function clearForm(){
  editingId=null;
  $("#editHint").textContent="";
  $("#btnCancelEdit").style.display="none";
  showFormError("");
  $("#form").reset();
  setRadio("deal","rent");
  setRadio("type","commercial");
  setRadio("resSub","apartment");
  setRadio("elec","single");
  syncResidential();
  syncDealBoxes();
}
$("#btnClear").addEventListener("click", function(){ clearForm(); toast("ÙØ±Ù… Ù¾Ø§Ú© Ø´Ø¯",""); });
$("#btnCancelEdit").addEventListener("click", function(){ clearForm(); setActiveView("saved"); });

function collectAmenities(){
  var out=[];
  var am=$$(".amen");
  for(var i=0;i<am.length;i++){
    if(am[i].checked) out.push(am[i].value);
  }
  return out;
}
function buildItemOrError(){
  var title = ($("#fTitle").value||"").trim(); /* Ù…Ù†Ø·Ù‚Ù‡ */
  var person = ($("#fPerson").value||"").trim();
  var phone = ($("#fPhone").value||"").trim();
  var location = ($("#fLocation").value||"").trim();
  var area = parseMoney($("#fArea").value);

  var deal = getRadio("deal") || "rent";
  var type = getRadio("type") || "commercial";
  var resSub = (type==="residential") ? (getRadio("resSub")||"") : "";

  if(!title) return {ok:false,msg:"Ù…Ù†Ø·Ù‚Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
  if(!person) return {ok:false,msg:"Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÙØ±Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
  if(!phone) return {ok:false,msg:"Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ÙØ±Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
  if(!location) return {ok:false,msg:"Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
  if(area==null || area<=0) return {ok:false,msg:"Ù…ØªØ±Ø§Ú˜ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª."};
  if(type==="residential" && !resSub) return {ok:false,msg:"Ø²ÛŒØ±Ù†ÙˆØ¹ Ù…Ø³Ú©ÙˆÙ†ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†."};

  var deposit=null, monthly=null, salePrice=null, bayane=null;
  if(deal==="rent"){
    deposit = parseMoney($("#fDeposit").value);
    monthly = parseMoney($("#fMonthly").value);
    bayane  = parseMoney($("#fBayaneRent").value);
    if(deposit==null) return {ok:false,msg:"Ù…Ø¨Ù„Øº Ø±Ù‡Ù†/ÙˆØ¯ÛŒØ¹Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
    if(monthly==null) return {ok:false,msg:"Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø¨Ø±Ø§ÛŒ Ø±Ù‡Ù† Ú©Ø§Ù…Ù„: 0)."};
  }else{
    salePrice = parseMoney($("#fSalePrice").value);
    bayane    = parseMoney($("#fBayaneSale").value);
    if(salePrice==null || salePrice<=0) return {ok:false,msg:"Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†."};
  }

  var item = {
    id: editingId || uid(),
    title:title,
    personName:person,
    phone:phone,
    location:location,
    deal:deal,
    type:type,
    resSub:resSub,
    area:area,
    deposit:deposit,
    monthly:monthly,
    salePrice:salePrice,
    bayane:bayane,
    keyAval: !!$("#o_key").checked,
    kolangi: !!$("#o_kol").checked,
    full: !!$("#o_full").checked,
    amenities: collectAmenities(),
    desc: ($("#fDesc").value||"").trim(),
    createdAt: editingId ? (function(){
      for(var i=0;i<state.listings.length;i++){
        if(state.listings[i].id===editingId) return state.listings[i].createdAt || Date.now();
      }
      return Date.now();
    })() : Date.now(),
    updatedAt: Date.now()
  };
  return {ok:true,item:item};
}

function handleSave(){
  showFormError("");
  setLastAction("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…â€¦");

  var res = buildItemOrError();
  if(!res.ok){
    showFormError(res.msg);
    toast("Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯", res.msg);
    setLastAction("Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯: " + res.msg);
    return;
  }

  var item = res.item;

  if(editingId){
    var idx=-1;
    for(var i=0;i<state.listings.length;i++){
      if(state.listings[i].id===editingId){ idx=i; break; }
    }
    if(idx>=0) state.listings[idx]=item;
    toast("ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯ âœ…", "Ù…Ù†Ø·Ù‚Ù‡: " + item.title);
    setLastAction("ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯: " + item.title);
  }else{
    state.listings.unshift(item);
    toast("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…", "Ù…Ù†Ø·Ù‚Ù‡: " + item.title);
    setLastAction("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: " + item.title);
  }

  var ok = saveState();
  updateStoreStatus();
  if(!ok) toast("âš ï¸ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ø³ØªÙ‡ Ø§Ø³Øª", "ÙØ¹Ù„Ø§Ù‹ Ù…ÙˆÙ‚Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (ØªØ§ ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¨Ù†Ø¯ÛŒ).");

  $("#sQ").value = "";
  $("#sSort").value = "new";

  clearForm();
  setActiveView("saved");
}

$("#btnSave").addEventListener("click", function(){ handleSave(); });
$("#form").addEventListener("submit", function(e){ e.preventDefault(); handleSave(); });

/* ===== Saved list ===== */
function getMainPrice(it){ return it.deal==="sale" ? Number(it.salePrice||0) : Number(it.deposit||0); }
function sortListings(arr, mode){
  var out = arr.slice();
  if(mode==="old") out.sort(function(a,b){ return (a.createdAt||0)-(b.createdAt||0); });
  else if(mode==="priceAsc") out.sort(function(a,b){ return getMainPrice(a)-getMainPrice(b); });
  else if(mode==="priceDesc") out.sort(function(a,b){ return getMainPrice(b)-getMainPrice(a); });
  else if(mode==="areaAsc") out.sort(function(a,b){ return (a.area||0)-(b.area||0); });
  else if(mode==="areaDesc") out.sort(function(a,b){ return (b.area||0)-(a.area||0); });
  else out.sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); });
  return out;
}

function listingHTML(it, withDelete){
  var moneyLine = mainMoneyLine(it);
  var tags =
    '<span class="pill">'+esc(dealText(it.deal))+'</span>' +
    '<span class="pill">'+esc(typeText(it.type)) + (it.type==="residential" ? (" - "+esc(resSubText(it.resSub))) : "") + '</span>' +
    '<span class="pill">ğŸ“ Ù…ØªØ±Ø§Ú˜ '+fmt(it.area)+'</span>' +
    (it.keyAval?'<span class="pill good">ğŸ”‘ Ú©Ù„ÛŒØ¯ Ø§ÙˆÙ„</span>':"") +
    (it.kolangi?'<span class="pill warn">ğŸ§± Ú©Ù„Ù†Ú¯ÛŒ</span>':"") +
    (it.full?'<span class="pill good">âœ¨ ÙÙˆÙ„ Ø§Ù…Ú©Ø§Ù†Ø§Øª</span>':"");

  var phoneLink = 'tel:' + encodeURIComponent(String(it.phone||"").trim());

  return ''+
    '<div class="item">' +
      '<h4>Ù…Ù†Ø·Ù‚Ù‡: '+esc(it.title)+'</h4>' +
      '<div class="sub">' +
        'ğŸ“ '+esc(it.location) + '<br>' +
        '<span class="muted2">ğŸ‘¤</span> '+esc(it.personName)+' â€¢ <span class="muted2">ğŸ“</span> '+esc(it.phone) +
      '</div>' +
      '<div class="priceTag"><span class="k">ğŸ’°</span><span>'+esc(moneyLine)+'</span></div>' +
      '<div class="meta">'+ tags +'</div>' +
      '<div class="btns">' +
        '<button class="btn ghost" type="button" onclick="editListing(\''+it.id+'\')">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>' +
        '<button class="btn ghost" type="button" onclick="gotoContract(\''+it.id+'\')">ğŸ“„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>' +
        '<a class="btn ghost" href="'+esc(phoneLink)+'">ğŸ“ ØªÙ…Ø§Ø³</a>' +
        (withDelete ? '<button class="btn danger" type="button" onclick="deleteListing(\''+it.id+'\')">ğŸ—‘ï¸ Ø­Ø°Ù</button>' : '') +
      '</div>' +
    '</div>';
}

function renderSaved(){
  renderDashboard();

  var q = ($("#sQ").value||"").trim().toLowerCase();
  var sort = $("#sSort").value || "new";

  var arr = state.listings.slice();

  if(q){
    arr = arr.filter(function(it){
      var hay = (it.title+" "+it.location+" "+it.personName+" "+it.phone).toLowerCase();
      return hay.indexOf(q) >= 0;
    });
  }
  arr = sortListings(arr, sort);

  $("#savedCount").textContent = arr.length.toLocaleString("fa-IR") + " Ù…ÙˆØ±Ø¯";
  $("#savedEmpty").style.display = state.listings.length ? "none" : "";
  $("#savedList").innerHTML = arr.map(function(it){ return listingHTML(it, true); }).join("");

  renderSearch();
  renderContractOptions();
}

$("#sQ").addEventListener("input", renderSaved);
$("#sSort").addEventListener("change", renderSaved);

window.deleteListing = function(id){
  if(!confirm("Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
  state.listings = state.listings.filter(function(x){ return x.id!==id; });
  saveState();
  updateStoreStatus();
  toast("Ø­Ø°Ù Ø´Ø¯ âœ…","");
  renderSaved();
};

window.editListing = function(id){
  var it=null;
  for(var i=0;i<state.listings.length;i++){
    if(state.listings[i].id===id){ it=state.listings[i]; break; }
  }
  if(!it) return;

  editingId = id;
  $("#editHint").textContent = "Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´â€¦";
  $("#btnCancelEdit").style.display = "";
  showFormError("");

  $("#fTitle").value = it.title || "";
  $("#fPerson").value = it.personName || "";
  $("#fPhone").value = it.phone || "";
  $("#fLocation").value = it.location || "";
  $("#fArea").value = String(it.area || "");

  setRadio("deal", it.deal || "rent");
  setRadio("type", it.type || "commercial");
  setRadio("resSub", it.resSub || "apartment");
  setRadio("elec", "single");
  syncResidential();
  syncDealBoxes();

  $("#fDeposit").value = it.deposit!=null ? String(it.deposit) : "";
  $("#fMonthly").value = it.monthly!=null ? String(it.monthly) : "";
  $("#fBayaneRent").value = (it.deal==="rent" && it.bayane!=null) ? String(it.bayane) : "";
  $("#fSalePrice").value = it.salePrice!=null ? String(it.salePrice) : "";
  $("#fBayaneSale").value = (it.deal==="sale" && it.bayane!=null) ? String(it.bayane) : "";

  $("#o_key").checked = !!it.keyAval;
  $("#o_kol").checked = !!it.kolangi;
  $("#o_full").checked = !!it.full;

  var am = $$(".amen");
  for(var j=0;j<am.length;j++) am[j].checked = false;
  (it.amenities||[]).forEach(function(a){
    for(var k=0;k<am.length;k++){
      if(am[k].value===a) am[k].checked=true;
    }
  });

  $("#fDesc").value = it.desc || "";

  setActiveView("new");
};

/* ===== SEARCH filters ===== */
function collectSearchAmenities(){
  var out=[];
  var am = $$(".sfAmen");
  for(var i=0;i<am.length;i++){
    if(am[i].checked) out.push(am[i].value);
  }
  return out;
}
function syncSearchFilterUI(){
  var deal = ($("#sfDeal").value || "any");
  var type = ($("#sfType").value || "any");

  var minL = $("#sfPriceMinLabel");
  var maxL = $("#sfPriceMaxLabel");

  if(deal==="rent"){
    if(minL) minL.textContent = "Ø±Ù‡Ù†/ÙˆØ¯ÛŒØ¹Ù‡ Ø§Ø²";
    if(maxL) maxL.textContent = "Ø±Ù‡Ù†/ÙˆØ¯ÛŒØ¹Ù‡ ØªØ§";
    $("#sfRentOnly").style.display = "";
  }else if(deal==="sale"){
    if(minL) minL.textContent = "Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ Ø§Ø²";
    if(maxL) maxL.textContent = "Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ ØªØ§";
    $("#sfRentOnly").style.display = "none";
    $("#sfMonthlyMin").value="";
    $("#sfMonthlyMax").value="";
  }else{
    if(minL) minL.textContent = "Ù‚ÛŒÙ…Øª/Ø±Ù‡Ù† Ø§Ø²";
    if(maxL) maxL.textContent = "Ù‚ÛŒÙ…Øª/Ø±Ù‡Ù† ØªØ§";
    $("#sfRentOnly").style.display = "none";
    $("#sfMonthlyMin").value="";
    $("#sfMonthlyMax").value="";
  }

  $("#sfResSubWrap").style.display = (type==="residential") ? "" : "none";
  if(type!=="residential") $("#sfResSub").value = "any";
}
function resetSearchFilters(){
  $("#sfDeal").value="any";
  $("#sfType").value="any";
  $("#sfResSub").value="any";

  $("#sfAreaMin").value="";
  $("#sfAreaMax").value="";
  $("#sfPriceMin").value="";
  $("#sfPriceMax").value="";
  $("#sfMonthlyMin").value="";
  $("#sfMonthlyMax").value="";

  $("#sfKey").checked=false;
  $("#sfKol").checked=false;
  $("#sfFull").checked=false;

  var am=$$(".sfAmen");
  for(var i=0;i<am.length;i++) am[i].checked=false;

  syncSearchFilterUI();
}

function renderSearch(){
  var q = ($("#q").value||"").trim().toLowerCase();
  var arr = state.listings.slice();

  if(q){
    arr = arr.filter(function(it){
      var hay = (it.title+" "+it.location+" "+it.personName+" "+it.phone).toLowerCase();
      return hay.indexOf(q) >= 0;
    });
  }

  var fDeal = $("#sfDeal").value || "any";
  var fType = $("#sfType").value || "any";
  var fResSub = $("#sfResSub").value || "any";

  var areaMin = parseMoney($("#sfAreaMin").value);
  var areaMax = parseMoney($("#sfAreaMax").value);

  var priceMin = parseMoney($("#sfPriceMin").value);
  var priceMax = parseMoney($("#sfPriceMax").value);

  var monthlyMin = parseMoney($("#sfMonthlyMin").value);
  var monthlyMax = parseMoney($("#sfMonthlyMax").value);

  var needKey = !!$("#sfKey").checked;
  var needKol = !!$("#sfKol").checked;
  var needFull = !!$("#sfFull").checked;

  var needAmenities = collectSearchAmenities();

  arr = arr.filter(function(it){
    if(fDeal!=="any" && it.deal!==fDeal) return false;
    if(fType!=="any" && it.type!==fType) return false;

    if(fType==="residential" && fResSub!=="any"){
      if(it.resSub!==fResSub) return false;
    }

    var a = Number(it.area||0);
    if(areaMin!=null && a < areaMin) return false;
    if(areaMax!=null && a > areaMax) return false;

    var p = (it.deal==="sale") ? Number(it.salePrice||0) : Number(it.deposit||0);
    if(priceMin!=null && p < priceMin) return false;
    if(priceMax!=null && p > priceMax) return false;

    if(fDeal==="rent"){
      var m = Number(it.monthly||0);
      if(monthlyMin!=null && m < monthlyMin) return false;
      if(monthlyMax!=null && m > monthlyMax) return false;
    }

    if(needKey && !it.keyAval) return false;
    if(needKol && !it.kolangi) return false;
    if(needFull && !it.full) return false;

    if(needAmenities.length){
      var have = it.amenities || [];
      for(var i=0;i<needAmenities.length;i++){
        if(have.indexOf(needAmenities[i]) < 0) return false;
      }
    }
    return true;
  });

  $("#searchCount").textContent = arr.length.toLocaleString("fa-IR") + " Ù…ÙˆØ±Ø¯";
  $("#resultEmpty").style.display = arr.length ? "none" : "";
  $("#resultList").innerHTML = arr.map(function(it){ return listingHTML(it, false); }).join("");
}

$("#q").addEventListener("input", renderSearch);
$("#btnResetSearch").addEventListener("click", function(){
  $("#q").value="";
  resetSearchFilters();
  renderSearch();
});
$("#btnClearFilters").addEventListener("click", function(){
  resetSearchFilters();
  renderSearch();
});
["sfDeal","sfType","sfResSub","sfAreaMin","sfAreaMax","sfPriceMin","sfPriceMax","sfMonthlyMin","sfMonthlyMax","sfKey","sfKol","sfFull"].forEach(function(id){
  var el = document.getElementById(id);
  if(el){
    el.addEventListener("input", function(){
      if(id==="sfDeal" || id==="sfType") syncSearchFilterUI();
      renderSearch();
    });
    el.addEventListener("change", function(){
      if(id==="sfDeal" || id==="sfType") syncSearchFilterUI();
      renderSearch();
    });
  }
});
$$(".sfAmen").forEach(function(el){
  el.addEventListener("change", renderSearch);
});

/* ===== Contract ===== */
function renderContractOptions(){
  var sel=$("#cListing");
  if(!state.listings.length){
    sel.innerHTML = '<option value="">â€” Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€”</option>';
    return;
  }
  var cur = sel.value;
  sel.innerHTML = state.listings.map(function(it){
    return '<option value="'+esc(it.id)+'">Ù…Ù†Ø·Ù‚Ù‡: '+esc(it.title)+'</option>';
  }).join("");
  sel.value = (cur && state.listings.some(function(x){ return x.id===cur; })) ? cur : state.listings[0].id;
}
function buildContractText(it){
  var owner = ($("#cOwner").value || it.personName || "").trim();
  var other = ($("#cOther").value || "").trim();

  var moneyBlock = "";
  if(it.deal==="rent"){
    moneyBlock = "Ø±Ù‡Ù†/ÙˆØ¯ÛŒØ¹Ù‡: "+fmt(it.deposit)+" ØªÙˆÙ…Ø§Ù†\n"
      + "Ø§Ø¬Ø§Ø±Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡: "+fmt(it.monthly)+" ØªÙˆÙ…Ø§Ù†\n"
      + (it.bayane!=null ? ("Ø¨ÛŒØ¹Ø§Ù†Ù‡: "+fmt(it.bayane)+" ØªÙˆÙ…Ø§Ù†\n") : "");
  }else{
    moneyBlock = "Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´: "+fmt(it.salePrice)+" ØªÙˆÙ…Ø§Ù†\n"
      + (it.bayane!=null ? ("Ø¨ÛŒØ¹Ø§Ù†Ù‡: "+fmt(it.bayane)+" ØªÙˆÙ…Ø§Ù†\n") : "");
  }

  return "Ø¨Ø³Ù…Ù‡ ØªØ¹Ø§Ù„ÛŒ\n\n"
    + "Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ "+dealText(it.deal)+"\n\n"
    + "Û±) "+(owner||"â€¦â€¦â€¦â€¦â€¦â€¦â€¦")+" (Ù…Ø§Ù„Ú©/ÙØ±ÙˆØ´Ù†Ø¯Ù‡/Ù…ÙˆØ¬Ø±)\n"
    + "Û²) "+(other||"â€¦â€¦â€¦â€¦â€¦â€¦â€¦")+" (Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„)\n\n"
    + "Ù…Ø´Ø®ØµØ§Øª Ù…Ù„Ú©:\n"
    + "- Ù…Ù†Ø·Ù‚Ù‡: "+(it.title||"â€”")+"\n"
    + "- Ù†ÙˆØ¹ Ù…Ù„Ú©: "+typeText(it.type)+(it.type==="residential" ? (" - "+resSubText(it.resSub)) : "")+"\n"
    + "- Ù…ÙˆÙ‚Ø¹ÛŒØª: "+(it.location||"â€”")+"\n"
    + "- Ù…ØªØ±Ø§Ú˜: "+(it.area||"â€”")+" Ù…ØªØ±\n"
    + "- ØªÙ„ÙÙ† Ù…Ø§Ù„Ú©: "+(it.phone||"â€”")+"\n\n"
    + "Ù…Ø¨Ø§Ù„Øº:\n"+moneyBlock+"\n"
    + "Ø§Ù…Ø¶Ø§:\n"
    + "Ø§Ù…Ø¶Ø§ÛŒ Ù…Ø§Ù„Ú©: â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦\n"
    + "Ø§Ù…Ø¶Ø§ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„: â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦\n";
}
function renderContract(){
  renderContractOptions();
  var id = $("#cListing").value;
  var it=null;
  for(var i=0;i<state.listings.length;i++){
    if(state.listings[i].id===id){ it=state.listings[i]; break; }
  }
  if(!it){ $("#cText").value="Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."; return; }
  if(!$("#cOwner").value) $("#cOwner").value = it.personName || "";
  $("#cText").value = buildContractText(it);
}
window.gotoContract = function(id){
  setActiveView("contract");
  $("#cListing").value = id;
  var it=null;
  for(var i=0;i<state.listings.length;i++){
    if(state.listings[i].id===id){ it=state.listings[i]; break; }
  }
  if(it) $("#cOwner").value = it.personName || "";
  renderContract();
};
["cListing","cOwner","cOther"].forEach(function(id){
  $("#"+id).addEventListener("input", renderContract);
  $("#"+id).addEventListener("change", renderContract);
});
$("#btnCopy").addEventListener("click", function(){
  var txt = $("#cText").value || "";
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(function(){ toast("Ú©Ù¾ÛŒ Ø´Ø¯ âœ…",""); })
    .catch(function(){ toast("Ú©Ù¾ÛŒ Ù†Ø´Ø¯","Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†."); });
  }else{
    toast("Ú©Ù¾ÛŒ Ù†Ø´Ø¯","Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†.");
  }
});

/* ===== Settings ===== */
function renderSettings(){
  $("#debugLine").textContent = "Ø­Ø§Ù„Øª Ø°Ø®ÛŒØ±Ù‡: " + (storageMode==="localStorage" ? "Ø¯Ø§Ø¦Ù…ÛŒ âœ…" : "Ù…ÙˆÙ‚Øª âš ï¸");
}
$("#btnWipe").addEventListener("click", function(){
  if(!confirm("Ù‡Ù…Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ")) return;
  state.listings = [];
  try{ localStorage.removeItem(APP_KEY); }catch(e){}
  updateStoreStatus();
  toast("Ø­Ø°Ù Ø´Ø¯ âœ…","");
  renderSaved();
  setActiveView("saved");
});

/* ===== Init ===== */
(function init(){
  loadTheme();
  loadState();
  updateStoreStatus();

  setRadio("deal","rent");
  setRadio("type","commercial");
  setRadio("resSub","apartment");
  setRadio("elec","single");

  syncResidential();
  syncDealBoxes();

  resetSearchFilters();
  syncSearchFilterUI();

  // mount dashboard default into saved
  mountDashboard("saved");

  renderSaved();
  renderSearch();
  renderContract();
  renderSettings();
  setLastAction("Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
})();
</script>
</body>
</html>
